<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Authentication</title>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>

<body>
    <div id="app">
        <button id="signInBtn">Sign In/Up</button>
        <div id="userDetails" style="display: none;">
            <img id="userPhoto" width="50" height="50" style="border-radius: 50%;">
            <p id="userName"></p>
            <p id="userPoints"></p>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCYy8IoPO1w6wwVmKZ25rEY0462ULx6v7E",
            authDomain: "usual-queries-login.firebaseapp.com",
            databaseURL: "https://usual-queries-login-default-rtdb.firebaseio.com",
            projectId: "usual-queries-login",
            storageBucket: "usual-queries-login.appspot.com",
            messagingSenderId: "808817795355",
            appId: "1:808817795355:web:6a2454e71cdce466f773be",
            measurementId: "G-T9V22WWTBK"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const database = firebase.database();

        const signInBtn = document.getElementById('signInBtn');
        const userDetails = document.getElementById('userDetails');
        const userPhoto = document.getElementById('userPhoto');
        const userName = document.getElementById('userName');
        const userPoints = document.getElementById('userPoints');

        signInBtn.addEventListener('click', async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                const user = result.user;

                if (user.email.endsWith('@gsv.ac.in')) {
                    userDetails.style.display = 'block';
                    userPhoto.src = user.photoURL;
                    userName.innerText = user.displayName;

                    // Get or create user data in Realtime Database
                    const userRef = database.ref('users/' + user.uid);
                    userRef.once('value', (snapshot) => {
                        const userData = snapshot.val();
                        if (userData) {
                            const points = userData.points || 0;
                            userRef.set({ points: points + 100 });
                        } else {
                            userRef.set({ points: 100 });
                        }
                        userPoints.innerText = `Points: ${snapshot.val().points}`;
                    });
                } else {
                    alert('You are not from gsv.ac.in. Please sign in with a valid account.');
                    auth.signOut();
                }
            } catch (error) {
                console.error(error);
            }
        });

        // Check if user is already signed in
        auth.onAuthStateChanged(async (user) => {
            if (user && user.email.endsWith('@gsv.ac.in')) {
                userDetails.style.display = 'block';
                userPhoto.src = user.photoURL;
                userName.innerText = user.displayName;

                // Get or create user data in Realtime Database
                const userRef = database.ref('users/' + user.uid);
                userRef.once('value', (snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        const points = userData.points || 0;
                        userRef.set({ points: points + 100 });
                    } else {
                        userRef.set({ points: 100 });
                    }
                    userPoints.innerText = `Points: ${snapshot.val().points}`;
                });
            } else {
                userDetails.style.display = 'none';
            }
        });
    </script>
</body>

</html>